<script>
document.addEventListener('DOMContentLoaded', function () {
  initCirurgias();
});

function initCirurgias() {
  loadCirurgias();
  document.getElementById('surgeryForm').addEventListener('submit', handleCirurgiaSubmit);
  document.getElementById('cancelEditBtn').addEventListener('click', resetCirurgiaForm);
  document.getElementById('statusFilter').addEventListener('change', loadCirurgias);
}

function loadCirurgias() {
  google.script.run
    .withSuccessHandler(displayCirurgias)
    .withFailureHandler(showError)
    .getCirurgias();
}

function displayCirurgias(data) {
  const tbody = document.querySelector('#surgeryTable tbody');
  tbody.innerHTML = '';
  const filtro = document.getElementById('statusFilter').value;
  data.filter(r => filtro === 'Todos' || r.StatusCirurgia === filtro)
    .forEach(row => {
      const tr = tbody.insertRow();
      [
        'ID_Paciente', 'Nome', 'Data de Nascimento', 'CPF', 'Telefone',
        'Hospital', 'Tipo de Cirurgia', 'Prótese - Marca', 'Laser',
        'NomeAnestesista', 'NomeInstrumentadora', 'Data da Cirurgia',
        'Hora Internação', 'Hora do Início da Cirurgia', 'Tempo de sala',
        'DataRetorno', 'Observação', 'StatusCirurgia'
      ].forEach(campo => {
        tr.insertCell().textContent = row[campo] || '';
      });
    });
}

function handleCirurgiaSubmit(e) {
  e.preventDefault();
  const btn = document.getElementById('saveSurgeryBtn');
  btn.disabled = true;

  const dados = {
    'ID_Paciente': document.getElementById('idPaciente').value,
    'Nome': document.getElementById('nomePaciente').value,
    'Tipo de Cirurgia': document.getElementById('tipoCirurgia').value,
    'Hospital': document.getElementById('hospital').value,
    'Data da Cirurgia': document.getElementById('dataCirurgia').value,
    'StatusCirurgia': document.getElementById('statusCirurgia').value
  };

  if (!dados['ID_Paciente'] || !dados['Nome']) {
    alert('Preencha os campos obrigatórios.');
    btn.disabled = false;
    return;
  }

  google.script.run
    .withSuccessHandler(() => {
      resetCirurgiaForm();
      loadCirurgias();
      btn.disabled = false;
    })
    .withFailureHandler(err => {
      showError(err);
      btn.disabled = false;
    })
    .addCirurgia(dados);
}

function resetCirurgiaForm() {
  document.getElementById('surgeryForm').reset();
  document.getElementById('saveSurgeryBtn').textContent = 'Salvar Cirurgia';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

function showError(error) {
  alert('Erro: ' + error.message);
}
</script>
