<script>
document.addEventListener('DOMContentLoaded', function () {
  initAgendamento();
});

function initAgendamento() {
  loadAgendamentos();
  document.getElementById('appointmentForm').addEventListener('submit', handleAgendamentoSubmit);
  document.getElementById('cancelEditBtn').addEventListener('click', resetAgendamentoForm);
  document.getElementById('statusFilter').addEventListener('change', loadAgendamentos);
}

function loadAgendamentos() {
  google.script.run
    .withSuccessHandler(displayAgendamentos)
    .withFailureHandler(showError)
    .getAppointments();
}

function displayAgendamentos(data) {
  const tbody = document.querySelector('#appointmentsTable tbody');
  tbody.innerHTML = '';
  const filtro = document.getElementById('statusFilter').value;
  data.filter(row => filtro === 'Todos' || row.Status === filtro)
    .forEach(row => {
      const tr = tbody.insertRow();
      tr.insertCell().textContent = row.ID;
      tr.insertCell().textContent = row.Data;
      tr.insertCell().textContent = row.Hora;
      tr.insertCell().textContent = row.Cliente;
      tr.insertCell().textContent = row['Email Cliente'] || '';
      tr.insertCell().textContent = row.Servico;
      tr.insertCell().textContent = row.Status;

      const actionsCell = tr.insertCell();

      const editBtn = document.createElement('button');
      editBtn.textContent = 'Editar';
      editBtn.onclick = () => carregarAgendamentoParaEdicao(row);
      actionsCell.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Excluir';
      deleteBtn.style.marginLeft = '5px';
      deleteBtn.onclick = () => deletarAgendamento(row.ID);
      actionsCell.appendChild(deleteBtn);

      const emailBtn = document.createElement('button');
      emailBtn.textContent = 'Email';
      emailBtn.style.marginLeft = '5px';
      emailBtn.onclick = () => enviarEmailAgendamento(row);
      actionsCell.appendChild(emailBtn);
    });
}

function handleAgendamentoSubmit(e) {
  e.preventDefault();
  const btn = document.getElementById('saveAppointmentBtn');
  btn.disabled = true;

  const id = document.getElementById('appointmentId')?.value || '';
  const dados = {
    Data: document.getElementById('dataAgendamento')?.value || '',
    Hora: document.getElementById('horaAgendamento')?.value || '',
    Cliente: document.getElementById('clienteAgendamento')?.value || '',
    EmailCliente: document.getElementById('emailClienteAgendamento')?.value || '',
    Servico: document.getElementById('servicoAgendamento')?.value || '',
    Status: document.getElementById('statusAgendamento')?.value || '',
    Observacoes: document.getElementById('observacoesAgendamento')?.value || ''
  };

  if (!dados.Cliente || dados.Cliente.length < 2) {
    alert('Nome do cliente é obrigatório.');
    btn.disabled = false;
    return;
  }

  if (dados.EmailCliente && !dados.EmailCliente.includes('@')) {
    alert('Endereço de e-mail inválido.');
    btn.disabled = false;
    return;
  }

  const callback = () => {
    resetAgendamentoForm();
    loadAgendamentos();
    btn.disabled = false;
  };

  if (id) {
    google.script.run.withSuccessHandler(callback).withFailureHandler(err => {
      showError(err);
      btn.disabled = false;
    }).updateAppointment(parseInt(id), dados);
  } else {
    google.script.run.withSuccessHandler(callback).withFailureHandler(err => {
      showError(err);
      btn.disabled = false;
    }).addAppointment(dados);
  }
}

function carregarAgendamentoParaEdicao(row) {
  document.getElementById('appointmentId').value = row.ID;
  document.getElementById('dataAgendamento').value = row.Data;
  document.getElementById('horaAgendamento').value = row.Hora;
  document.getElementById('clienteAgendamento').value = row.Cliente;
  document.getElementById('emailClienteAgendamento').value = row['Email Cliente'];
  document.getElementById('servicoAgendamento').value = row.Servico;
  document.getElementById('statusAgendamento').value = row.Status;
  document.getElementById('observacoesAgendamento').value = row.Observacoes;

  document.getElementById('saveAppointmentBtn').textContent = 'Atualizar Agendamento';
  document.getElementById('cancelEditBtn').style.display = 'inline-block';
}

function resetAgendamentoForm() {
  document.getElementById('appointmentId').value = '';
  document.getElementById('appointmentForm').reset();
  document.getElementById('saveAppointmentBtn').textContent = 'Salvar Agendamento';
  document.getElementById('cancelEditBtn').style.display = 'none';
}

function deletarAgendamento(id) {
  if (confirm('Deseja excluir este agendamento?')) {
    google.script.run.withSuccessHandler(loadAgendamentos).deleteAppointment(parseInt(id));
  }
}

function enviarEmailAgendamento(agendamento) {
  const recipient = agendamento['Email Cliente'];
  if (!recipient) {
    alert('Este agendamento não possui e-mail.');
    return;
  }
  const subject = `Confirmação de Agendamento - ${agendamento.Servico}`;
  const body = `Olá ${agendamento.Cliente},\n\nSeu agendamento para ${agendamento.Servico} está marcado para ${agendamento.Data} às ${agendamento.Hora}.\n\nObservações: ${agendamento.Observacoes || 'Nenhuma'}\n\nAtenciosamente,\nClínica Dr. Marcio`;

  if (confirm(`Deseja enviar este e-mail para ${recipient}?`)) {
    google.script.run
      .withSuccessHandler(() => alert('E-mail enviado com sucesso.'))
      .withFailureHandler(showError)
      .sendEmailNotification(recipient, subject, body);
  }
}

function showError(error) {
  alert('Erro: ' + error.message);
}
</script>
